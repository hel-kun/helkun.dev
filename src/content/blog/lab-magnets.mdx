---
title: '研究室の入退室マグネットを勝手に改造したい'
description: '勝手に変なものを作って研究室のボスっちを怖がらせましょう'
tags: ["Advent Calendar","技術","研究"]
date: 2025-12-23
heroImage: 'https://res.cloudinary.com/helkun/image/upload/v1766038050/helkun.dev/blog/lab-magnets/HeroImage.png'
published: true
---
この記事は**UEC Advent Calendar 2025の23日目の記事**となります。
<UrlCard url="https://adventar.org/calendars/11571"/>

前日はえぐちさんによるゴリゴリ技術系の記事が出る予定でした。
あれ、まだ書かれていない...？
<br/>

UECアドベントカレンダーにはその2も生えています。
<UrlCard url="https://adventar.org/calendars/11846"/>
その2の前日の記事はクリーパーさんの「NewTek NDI PTZ1 を買ってみた」です。
<UrlCard url="https://qiita.com/Kuripa_chan/items/7806c78298ff8a2121c3" />

このオタクは一般のご家庭には到底ないであろう機材を普通に持っていたりするので、ある意味怖いです。
<br/>

こんにちは、へるくんです。普段は研究室で研究以外のことを色々やっています。本当は研究したほうがいいです。

今回は、研究室の入退室マグネットの改造を現在進行形で行っている話をします。

## 研究室の入退室マグネットとは？
研究室の入退室マグネットとは、研究室のドアに取り付られている、現在の在室状況を指し示すマグネットのことです。

<ImgCard title="これ" alt="研究室の入退室マグネット" url="https://res.cloudinary.com/helkun/image/upload/v1765714141/helkun.dev/blog/lab-magnets/magnets.jpg" />

私の研究室には

- 在室
- 学内
- すぐ戻る
- 外出
- しばらく居ません
- 帰宅

の6種類のマグネットが用意されており、研究室のメンバーは自分の在室状況に応じてこれらのマグネットを動かしてドアに貼り付けています。

## 改造の動機
さて、私は研究とは別でなでエッグというペットロボットの開発も行っています。

<ImgCard title="こんなやつ" alt="なでエッグ" url="https://res.cloudinary.com/helkun/image/upload/v1765774872/helkun.dev/blog/lab-magnets/nadegg.png" />

これは3人で行っているプロジェクトであり、東3号館7階のオープンラボというところで集まって開発を行っています。
ここで発生するのが、研究室のある西10号館とオープンラボのある東3号館の行き来です。

最初は研究室に戻ってくるつもりで、在室状況を「学内」にしてからオープンラボに向かっていました。
しかし、オープンラボでの作業が長引いて21時〜22時くらいにまでなると、研究室に戻るのが面倒になります。帰宅方向は調布駅方面なので、研究室に戻らずそのまま帰宅したいのです。
しかし、在室状況を「帰宅」に戻すために一度研究室に戻る必要があり、これが非常に厄介でした。
<br/>

この問題を解決する方法として考えられるのは、あらかじめ在室状況を「帰宅」にしてからオープンラボに向かうことです。これで解決ですね。

問題が解決したので、これで世界は平和になりました。めでたしめでたし...。

...
<br/>
...
<br/>
...

<h1>ものづくりやりたすぎ！！！</h1>
ということで、学内のどの場所でも在室状況を変更できるようにします。

## 目的
大きく分けて2つの目的があります。
1. 研究室の外から在室状況を変更できるようにする
2. 光らせる

一つ目の目的はさっきから説明している通りです。
研究室の外から在室状況を変更できるようにすることで、オープンラボでの作業が長引いても、研究室に戻らずに在室状況を「帰宅」に変更できるようにします。

あと、せっかく改造するので、光らせたいですね。光らせるのはオタクのロマンです、きっと。

<ImgCard title="こんな感じにマトリクスLEDを並べるイメージ" alt="イメージ画像" url="https://res.cloudinary.com/helkun/image/upload/v1766038636/helkun.dev/blog/lab-magnets/image_rkdxmu.png"/>

## ハードウェアの構成
現状検討中のハードウェアの構成は以下の通りです。

<ImgCard title="ハードウェア構成図" alt="ハードウェア構成図" url="https://res.cloudinary.com/helkun/image/upload/v1765707828/helkun.dev/blog/lab-magnets/b123dae1-f217-4554-b6d5-9dd79fba35cb.png" />

ざっくりと説明します。
- 8×8のLEDマトリクス6個: 在室状況を表示するために使用します。各在室状況に対応して光ります。
- HT16K33A: 16×8のLEDマトリクスを制御するためのドライバICです。I2Cでマイコンと接続します。これ一つで8×8のLEDマトリクス2個を制御できます。いいね。
- Raspberry Pi Zero 2 W: マイコン兼サーバです。在室状況の変更を受け取ったり、LEDマトリクスを制御したりします。Webサーバを立てて、在室状況の変更を受け取る予定です。


ただ、いくつかボツにした案もあります。
<ImgCard title="ボツ案1" alt="ボツ案1" url="https://res.cloudinary.com/helkun/image/upload/v1765708022/helkun.dev/blog/lab-magnets/a7a88402-971b-46f7-8b73-93f21136199f.png" />

ボツ案1は、ESP32マイコンをラズパイとドライバICの間に挟む案です。ESP32マイコンはWi-Fiを搭載しているものもあるので、Wi-Fi経由で在室状況の変更を受け取ることができます。しかし、余計な無線通信を増やしたくなかったので、ボツにしました。

<ImgCard title="ボツ案2" alt="ボツ案2" url="https://res.cloudinary.com/helkun/image/upload/v1765707906/helkun.dev/blog/lab-magnets/07b3f973-e0f3-4b03-8f0c-9851bba95c18.png" />

ボツ案2は、ESP32マイコンだけで完結させる案です。ラズパイを使うのは割とオーバースペックなので、実はこれがかなり理想的とされています。
しかし、ESP32マイコンにWebサーバを立てるための知識が私にはありませんでした(<a href="https://www.moddable.com/">Moddable</a>を使用すればいけるらしいです)。これを機に勉強するのもありですが、それをするなら流石に研究をしろ(12月なので卒研追い込み時期です)ということで、今回はラズパイを使うことにしました。

## ソフトウェアなどの構成
ソフトウェアの構成は今の所こんな感じです。(一応図に起こしましたが間違っている可能性もあります、許して)

<ImgCard title="ソフトウェア構成図" alt="ソフトウェア構成図" url="https://res.cloudinary.com/helkun/image/upload/v1766059010/helkun.dev/blog/lab-magnets/28272395-9761-45f8-99c1-3ed90b64f72a.png" />

### 制御
HT16K33Aの制御にはPythonを使います。`pigpio`というライブラリを使用すればi2c通信ができるはず...。

### フレームワーク
今の所<a href="https://fastapi.tiangolo.com/ja/">FastAPI</a>にしようかなぁといった感じです。これは、LED制御をPythonで行う予定なので、WebもそのままPythonで書くかーというノリで検討しています。とはいえ、今回の用途に対してFastAPIはちょっと冗長ですね。LED制御をPythonで行うというのが理由なら普通に<a href="https://flask.palletsprojects.com/en/stable/">Flask</a>でもいいと思いますが、将来の拡張性を考えるとFastAPIかなーといった感じです。まあ、今は拡張する予定がなくとも、今後どうするかはわかりませんからね。
<br/>

あ、フロントエンドもFastAPIでやる予定です。

え、FastAPIはフロント向けではないよねって思う人しかいないと思いますが、シンプルなUIで十分と考えているのでFastAPIで無理やり作っても特に困らないだろうと思っています。ReactとかVueとかあるけど、今回の用途に対して過剰性能すぎます ~~(腰のあるhtml手打ちはしないんですかと言いたそうなそこの君、一旦黙って)~~。

もっと機能を盛り込みたくなったらちゃんとしたフロントエンドのフレームワークを導入するかもしれません。
<br/>
ここまで色々書きましたが、本当にこのフレームワーク構成でいいのか疑心暗鬼です。
もっと最適なフレームワークがあれば教えてください(切実)。

### ネットワーク
公開範囲は研究室のLAN内と私個人のTailnet内に限定する予定です。研究室のLANに関しては、せっかく作ったのでラボの人には遊んでほしいからです。Tailnetに関しては、私が外出先から在室状況を変更できるようにするためです。もっといい方法があるかもですが、ネットワーク周りの知識があまりないので、とりあえずTailnetによるVPN接続で対応しようと思っています。余計なことをしてセキュリティホールを作るのは避けたいので...。

## HT16K33Aのテスト
HT16K33Aがちゃんと動くかどうかを確認します。そこら辺に転がっていたラズパイpicoを用意して、ブレットボード上でテストを行いました。

が、配線がだるすぎる！！！

<ImgCard title="配線地獄" alt="HT16K33A配線地獄" url="https://res.cloudinary.com/helkun/image/upload/v1765711421/helkun.dev/blog/lab-magnets/bredboard.png" />
AnodeとCathodeを逆に繋いでしまい、なかなか光らなくて焦りましたが、無事に動作確認ができました。やったね。もう2度とこんな面倒なジャンパワイヤー配線はしたくないです。

## ラズパイZero 2 Wの環境構築
### 1. ラズパイZero 2 W本体のセットアップ
ラズパイZero 2 Wのセットアップを行います。
OSはDebian 13ベースのRaspberry Pi OSを使用します。
Raspberry Pi Imagerを使用して、microSDカードにRaspberry Pi OSをインストールすると大体は終わり。基本これだけなので便利ですね。
<br/>

これだけで終わるのは面白くないですね。
ラズパイにloginした際に表示されるメッセージをカスタマイズしましょう。
研究室で使用するので、弊研究室のマスコット的キャラクター(?)である「うにょーら」のアスキーアートを表示することにします(かわいくて好き)。

```txt
                    @@@@@             
                    @@   @            
                    @@    @           
                     @@@@@            
                     /                
                    /                 
                   /                  
      . ーーー＝- /_                    
    ／               ＼                
  ／                    ー.            
 /       ⚫︎                \           
/                  ⚫︎       \          
             \/\/           \         

```
アスキーアート作るの大変でした...(1時間以上かかった)。
ここに`figlet`というコマンドでアスキー文字を生成&アスキーアートの横に追加し、さらに`lolcat`というコマンドで虹色にします(この2つのコマンドはkat0hくんに教えてもらいました、感謝)。

<ImgCard title="こんな感じ" alt="カスタムメッセージ" url="https://res.cloudinary.com/helkun/image/upload/v1765709204/helkun.dev/blog/lab-magnets/raspberrypi_unyora.png" />

いい感じですね。これのためにラズパイにしたと言っても過言ではない...。

### 2. GPIOのセットアップ
HT16K33AはI2Cで接続するので、I2Cを有効化します。
`sudo raspi-config`を実行し、Interface Options -> I2C -> Yesの順に選択すればOKです。これも簡単。
<br/>

pythonでI2Cを使うためのライブラリとして、`pigpio`を使用します。しかし、Debian 13になってからは`sudo apt install pigpio`を叩いてもインストールできなくなってしまいました...。仕方がないので、ソースコードからビルドしてインストールする遠回りをすることにしました。

```bash frame=none
wget https://github.com/joan2937/pigpio/archive/master.zip
unzip master.zip
cd pigpio-master
make
```
これでおしまい。あとは、pigpioデーモンを起動しておきましょう。
```bash frame=none
sudo ldconfig
sudo pigpiod
```
`ldconfig`を実行することで、ライブラリのキャッシュを更新できるらしいです。pigpioデーモンを起動する際に`pigpiod: error while loading shared libraries: libpigpio.so.1: cannot open shared object file: No such file or directory`というエラーが出てしまったのでGeminiくんに聞いたら、`ldconfig`を実行すれば解決すると教えてもらいました。

### 3. python環境のセットアップ
みんな大好きであろうuv pythonを使用します。uvのセットアップは公式ドキュメントを見なさい！
<UrlCard url="https://docs.astral.sh/uv/" />

## 回路設計&基板設計
さて、ここまでできたら、次は回路設計と基板設計です。
KiCadを使用して設計を行います。kiCadの使い方はなでエッグチームの2人に教えてもらいました。感謝！

今回は、マトリクスLED&HT16K33Aの部分と、ラズパイZero 2 Wの部分の基板を分けて設計します。

### 1. マトリクスLED&HT16K33A基板
こいつは、8×8のマトリクスLEDを2個とHT16K33Aを1個搭載する基板です。
線を繋ぐ場所を間違えないようにに注意しながら設計します。

<ImgCard title="LED回路設計" alt="LED回路設計画面" url="https://res.cloudinary.com/helkun/image/upload/v1765710112/helkun.dev/blog/lab-magnets/led_kairo.png" />

いい感じの回路ですね。
これを基板に落とし込みます。
<ImgCard title="LED基板" alt="LED基板設計画面" url="https://res.cloudinary.com/helkun/image/upload/v1765710275/helkun.dev/blog/lab-magnets/led_kiban.png" />
うーん、配線がやばいですね。基板のサイズに制約がある(縦20mm、横80mm)関係上、配線がかなりタイトになっています。
残念ながら私は熟練のKiCadユーザーではないので、自動配線を使用しました。手動でやると時間がかかりすぎるので...。
ちなみに、マトリクスLEDで隠れる予定の真ん中のネジ穴2つは、磁石を取り付けるための穴です。これでドアに貼り付けることができます。

また、両側のピンヘッダは複数基板を繋げられるようにするためのものです。HT16K33AのI2Cアドレスさえ変えれば複数基板を繋げられるので拡張性があるうえに、基板発注のコストも抑えられます。20mm*240mmの基板を発注すると高くつくので、この基板を3枚繋げた60mm*80mmの形で発注します。

こいつの基板はビアを多用しているので、友人の基板と一緒にJLCPCBに発注する予定です(友人の分と一緒に発注することで送料を分担できます)。
配線にミスがないことを祈るばかり...。

### 2. ラズパイZero 2 W基板
こっちは既存のラズパイボードを乗せるだけなので簡単です。やることはラズパイのSDA、SCL、5V、GNDをLED基板に繋ぐだけ。
ただ、ラズパイZero 2 Wのボードに乗っている電源供給端子はmicro Bしかないので、別途type cの電源ポートを用意します。時代はtype c！！！
<ImgCard title="ラズパイ基板" alt="ラズパイ基板設計画面" url="https://res.cloudinary.com/helkun/image/upload/v1765711003/helkun.dev/blog/lab-magnets/raspberrypi_kiban.png" />

うーん、単純！電通大の<a href="https://www.pict-lab.uec.ac.jp/">ピクトラボ</a>にある基盤加工機で作成予定です。
<br/>

ちなみに、基板同士の接続に基板対基板コネクタは使わないのかい？というツッコミが入りそうですが、使いません。理由は単純で、私が存在を知らなかったからです...(後から教えてもらいました)。次こんなことをする機会があれば使ってみたいですね。

## 今後の予定
本当は23日までに完成を間に合わせたかったのですが、研究をはじめとする色々なタスクが忙しく、ここまでしかできていません。無念...。

<br/>
とりあえず基板が届いたらはんだ付けを行い、動作確認を行う必要があります。

そのあとはソフトウェア部分を本格的に実装する段階に入りたいですね。

あとは、簡易的なケースを3Dプリンタで作成したいですね。まだどんな感じにするか何も考えていませんが...。

## おわりに
12月ですし、こんなことする暇があるなら研究を進めるべきですが、たまにはこういう変なこともやりたいですよね。

あと、こんなことを勝手にやっても普通に許されるうちの研究室に感謝です。いい研究室だ...。
<br/>

明日はいずりなさんの記事になります。